/**
 * @file    pid.h
 * @brief   Заголовочный файл класса PID
 * @details Описание класса цифрового ПИД-регулятора
 * @author  Vladimir
 * @date    2025-12-09
 * @version 1.0
 */

#ifndef PID_H
#define PID_H

#include <vector>

/**
 * @class PID
 * @brief Класс цифрового ПИД-регулятора
 * 
 * Реализует цифровой ПИД-регулятор с дискретной передаточной функцией.
 * Поддерживает стандартную форму (Пропорционально-Интегрально-Дифференциальный регулятор).
 */
class PID {
private:
    double K;        ///< Коэффициент усиления (пропорциональная составляющая)
    double Ti;       ///< Постоянная времени интегрирования
    double Td;       ///< Постоянная времени дифференцирования
    double T0;       ///< Период дискретизации

    double q0;       ///< Коэффициент q0 дискретного регулятора
    double q1;       ///< Коэффициент q1 дискретного регулятора
    double q2;       ///< Коэффициент q2 дискретного регулятора

    double e_prev1 = 0.0;  ///< Ошибка на предыдущем шаге (e[k-1])
    double e_prev2 = 0.0;  ///< Ошибка на два шага назад (e[k-2])
    double u_prev = 0.0;   ///< Управляющее воздействие на предыдущем шаге

    double integral = 0.0; ///< Интегральная составляющая
    double d_prev = 0.0;   ///< Предыдущее значение производной

public:
    /**
     * @brief Конструктор класса PID
     * @param K Коэффициент усиления
     * @param Ti Постоянная времени интегрирования
     * @param Td Постоянная времени дифференцирования
     * @param T0 Период дискретизации (по умолчанию 1.0)
     * 
     * @note Инициализирует коэффициенты дискретного регулятора
     */
    PID(double K, double Ti, double Td, double T0 = 1.0);

    /**
     * @brief Расчет управляющего воздействия
     * @param setpoint Задающее воздействие
     * @param current_value Текущее значение процесса
     * @return Управляющее воздействие
     * 
     * Уравнение регулятора: u[k] = q0*e[k] + q1*e[k-1] + q2*e[k-2] + u[k-1]
     */
    double calculate(double setpoint, double current_value);

    /**
     * @brief Сброс состояния регулятора
     * 
     * Обнуляет все накопленные значения (интеграл, предыдущие ошибки и т.д.)
     */
    void reset();

    /**
     * @brief Получение коэффициентов дискретного регулятора
     * @return Вектор коэффициентов [q0, q1, q2]
     */
    std::vector<double> getCoefficients() const;

    /**
     * @brief Получение параметров ПИД-регулятора
     * @param[out] K_param Коэффициент усиления
     * @param[out] Ti_param Постоянная времени интегрирования
     * @param[out] Td_param Постоянная времени дифференцирования
     */
    void getParameters(double& K_param, double& Ti_param, double& Td_param) const;
};

#endif